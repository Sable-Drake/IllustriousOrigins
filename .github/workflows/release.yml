name: Create Release

on:
  release:
    types: [created]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        persist-credentials: true
      
    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version extracted: $VERSION"
        
        MAJOR=$(echo $VERSION | cut -d. -f1)
        MINOR=$(echo $VERSION | cut -d. -f2)
        PATCH=$(echo $VERSION | cut -d. -f3)
        echo "major=$MAJOR" >> $GITHUB_OUTPUT
        echo "minor=$MINOR" >> $GITHUB_OUTPUT
        echo "patch=$PATCH" >> $GITHUB_OUTPUT
        
    - name: Update mod_info.json with version
      env:
        VERSION: ${{ steps.get_version.outputs.version }}
      run: |
        python3 << 'PYEOF'
import json
import os

version = os.environ['VERSION']
with open('mod_info.json', 'r') as f:
    data = json.load(f)
data['version'] = version
with open('mod_info.json', 'w') as f:
    json.dump(data, f, indent=4)
print(f"Updated mod_info.json version to: {version}")
PYEOF
        cat mod_info.json
        
    - name: Update illustriousorigins.version file
      env:
        VERSION: ${{ steps.get_version.outputs.version }}
        MAJOR: ${{ steps.get_version.outputs.major }}
        MINOR: ${{ steps.get_version.outputs.minor }}
        PATCH: ${{ steps.get_version.outputs.patch }}
      run: |
        python3 << 'PYEOF'
import json
import os

version = os.environ['VERSION']
major = int(os.environ['MAJOR'])
minor = int(os.environ['MINOR'])
patch = os.environ['PATCH']
download_url = f"https://github.com/Sable-Drake/IllustriousOrigins/releases/download/{version}/IllustriousOrigins-{version}.zip"

try:
    patch_int = int(patch)
except ValueError:
    patch_int = patch

with open('illustriousorigins.version', 'r') as f:
    data = json.load(f)

data['modVersion'] = {
    'major': major,
    'minor': minor,
    'patch': patch_int
}
data['directDownloadURL'] = download_url

with open('illustriousorigins.version', 'w') as f:
    json.dump(data, f, indent='\t')
    
print(f"Updated illustriousorigins.version:")
print(f"  Version: {major}.{minor}.{patch}")
print(f"  Download URL: {download_url}")
PYEOF
        cat illustriousorigins.version
        
    - name: Commit and push version file update
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add illustriousorigins.version mod_info.json
        git commit -m "Update version to ${{ steps.get_version.outputs.version }}" || echo "No changes to commit"
        git push origin main || echo "Nothing to push"
        
    - name: Create mod zip file
      run: |
        MOD_NAME="IllustriousOrigins"
        ZIP_NAME="${MOD_NAME}-${{ steps.get_version.outputs.version }}.zip"
        
        mkdir -p ../temp_release
        cp -r . ../temp_release/${MOD_NAME}
        cd ../temp_release
        
        zip -r "${ZIP_NAME}" "${MOD_NAME}" \
          -x "${MOD_NAME}/.git/*" \
          -x "${MOD_NAME}/.github/*" \
          -x "${MOD_NAME}/*.DS_Store" \
          -x "${MOD_NAME}/*.iml" \
          -x "${MOD_NAME}/*.iws" \
          -x "${MOD_NAME}/*.ipr" \
          -x "${MOD_NAME}/.idea/*" \
          -x "${MOD_NAME}/.vscode/*" \
          -x "${MOD_NAME}/*.swp" \
          -x "${MOD_NAME}/*.swo" \
          -x "${MOD_NAME}/*~" \
          -x "${MOD_NAME}/Thumbs.db" \
          -x "${MOD_NAME}/desktop.ini" \
          -x "${MOD_NAME}/*.log" \
          -x "${MOD_NAME}/*.tmp" \
          -x "${MOD_NAME}/bin/*" \
          -x "${MOD_NAME}/out/*" \
          -x "${MOD_NAME}/build/*" \
          -x "${MOD_NAME}/dist/*"
        
        mv "${ZIP_NAME}" "../${MOD_NAME}/"
        cd "../${MOD_NAME}"
        echo "Created: $ZIP_NAME"
        ls -lh "$ZIP_NAME"
        echo "Zip contents (first 20 files):"
        unzip -l "$ZIP_NAME" | head -20
        
    - name: Upload release asset
      uses: softprops/action-gh-release@v1
      with:
        files: IllustriousOrigins-${{ steps.get_version.outputs.version }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

